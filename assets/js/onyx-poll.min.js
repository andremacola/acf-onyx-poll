!function(){"use strict";(new class{constructor(){self=this,this.response=null,this.prefix="onyx-poll",this.element={},this.name={parent:this.prefix,modal:`${this.prefix}-modal`,wrapper:`${this.prefix}-wrapper`,question:`${this.prefix}-question`,list:`${this.prefix}-choices`,choice:`${this.prefix}-choice`,footer:`${this.prefix}-footer`,message:`${this.prefix}-message`,total:`${this.prefix}-total`,voteButton:`${this.prefix}-vote`,viewButton:`${this.prefix}-view`,closeButton:`${this.prefix}-close`,loader:`${this.prefix}-loader`},this.submitVote=this.submitVote.bind(this)}prepareModal(){"undefined"!=typeof onyxPollModal&&(this.element.modal=document.getElementById("onyx-poll-modal"),this.requestModal().then(e=>this.renderModalTemplate(e,this.element.modal)).catch(e=>console.warn(e)))}requestModal(){return new Promise((e,t)=>{const s=new XMLHttpRequest;s.open("GET",`${onyxpoll.apiurl}onyx/polls/list/?modal=1`),s.send(null),s.onload=function(){this.status>=200&&this.status<400?(self.response=JSON.parse(this.response),e(self.response)):t("Poll cannot be loaded.")}})}requestVote(e){const t={choice:e.getAttribute("data-choice"),poll:e.getAttribute("data-poll")};return new Promise((e,s)=>{const o=new XMLHttpRequest;o.open("POST",`${onyxpoll.apiurl}onyx/polls/vote`),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(t)),o.onload=function(){this.status>=200&&this.status<400?(self.results=JSON.parse(this.response),e(JSON.parse(this.response))):s("Voting not completed.")}})}renderModalTemplate(e,t){t.innerHTML=`\n\t\t\t<div id='${this.name.wrapper}-${e.id}' class="${this.name.wrapper}">\n\t\t\t\t<p class='${this.name.question}'>${e.title}</p>\n\t\t\t\t<ul class='${this.name.list}'></ul>\n\t\t\t\t<div class="${this.name.footer}">\n\t\t\t\t\t<p class='${this.name.message}'></p>\n\t\t\t\t\t${e.results?`\n\t\t\t\t\t\t<p class='${this.name.total}'>\n\t\t\t\t\t\t\t<strong>${onyxpoll.labels.total}: </strong>\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t</p>\n\t\t\t\t\t`:""}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<span class="${this.name.loader}"><span class="spinner"></span></span>\n\t\t\t<span class="${this.name.closeButton}"></span>\n\t\t`,this.element.footer=document.querySelector(`.${this.name.footer}`),void 0!==e.results&&(this.element.footer.innerHTML+=`\n\t\t\t\t<a href="#" class="onyx-poll-ft-btn ${this.name.voteButton}">${onyxpoll.labels.vote}</a>\n\t\t\t\t<a href="#" class="onyx-poll-ft-btn ${this.name.viewButton}">${onyxpoll.labels.view}</a>`),this.element.list=document.querySelector(`.${this.name.list}`);for(const t of e.answers){const s=document.createElement("li");s.setAttribute("data-choice",t.option),s.setAttribute("data-poll",e.id),s.className=this.name.choice,s.textContent=t.answer,this.element.list.appendChild(s)}this.element.modal.classList.add("show"),this.eventHandlers()}eventHandlers(){this.element.parent=document.querySelector(`.${this.name.parent}`),this.element.choices=document.querySelectorAll(`.${this.name.choice}`),this.element.message=document.querySelector(`.${this.name.message}`),this.element.total=document.querySelector(`.${this.name.total} span`),this.element.voteButton=document.querySelector(`.${this.name.voteButton}`),this.element.viewButton=document.querySelector(`.${this.name.viewButton}`),this.element.closeButton=document.querySelector(`.${this.name.closeButton}`),this.element.loader=document.querySelector(`.${this.name.loader}`),this.element.closeButton.onclick=()=>this.element.modal.remove(),void 0!==this.response.results&&(this.element.viewButton.onclick=()=>this.showResults(),this.element.voteButton.onclick=()=>this.showPoll());for(let e=0;e<this.element.choices.length;e++)this.element.choices[e].addEventListener("click",this.submitVote)}submitVote(e){const t=e.target.parentNode.parentNode.parentNode;this.togglePollLoader(t,!1),this.requestVote(e.target).then(function(s){this.togglePollLoader(t,!0),this.handleMessage(s.message,s.code),t.classList.add("voted"),"success"==s.code&&e.target.classList.add("choosed"),void 0!==s.results?this.element.viewButton.click():this.element.list.remove()}.bind(this)).catch(function(){this.togglePollLoader(t,!0),this.handleMessage(onyxpoll.labels.error,"error")}.bind(this))}showResults(){const e=this.response;this.element.parent.classList.add("view"),this.element.total.textContent=e.results.total;const t=this.getCookie(`onyx_poll_cookie_${e.id}`);t&&document.querySelector(`li[data-choice="${t}"]`).classList.add("choosed");for(let t=0;t<this.element.choices.length;t++){const s=this.element.choices[t],o=e.answers[t].votes,n=e.answers[t].percent.toFixed(2)+"%";let l=`${o} ${onyxpoll.labels.votes} / ${n}`;2==this.response.results.type?l=`${o} ${onyxpoll.labels.votes}`:1==this.response.results.type&&(l=`${n}`),s.removeEventListener("click",this.submitVote),s.style.setProperty("--choicePercentage",`${n}`),s.style.setProperty("--choiceResult",`"${l}"`)}}showPoll(){this.element.parent.classList.remove("view");for(let e=0;e<this.element.choices.length;e++){const t=this.element.choices[e];t.addEventListener("click",this.submitVote),t.classList.remove("choosed"),t.style.removeProperty("--choicePercentage"),t.style.removeProperty("--choiceResult")}}handleMessage(e,t){const s=this.element.message;s.classList.remove("error","success","warn","not_allowed"),s.classList.add(t),s.textContent=e}togglePollLoader(e,t=!0){let s,o;t?(s="loading",o="active"):(s="active",o="loading"),e.classList.remove(s),e.classList.add(o)}getCookie(e){for(var t=e+"=",s=decodeURIComponent(document.cookie).split(";"),o=0;o<s.length;o++){for(var n=s[o];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}}).prepareModal()}();