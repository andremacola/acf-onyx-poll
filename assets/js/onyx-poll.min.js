!function(){"use strict";window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){var e,s=(this.document||this.ownerDocument).querySelectorAll(t),o=this;do{for(e=s.length;--e>=0&&s.item(e)!==o;);}while(e<0&&(o=o.parentElement));return o});new class{constructor(){self=this,this.response=[],this.prefix="onyx-poll",this.polls=document.querySelectorAll(".onyx-poll"),this.element={},this.name={parent:this.prefix,modal:`${this.prefix}-modal`,widget:`${this.prefix}-widget`,wrapper:`${this.prefix}-wrapper`,question:`${this.prefix}-question`,list:`${this.prefix}-choices`,choice:`${this.prefix}-choice`,footer:`${this.prefix}-footer`,message:`${this.prefix}-message`,total:`${this.prefix}-total`,voteButton:`${this.prefix}-vote`,viewButton:`${this.prefix}-view`,closeButton:`${this.prefix}-close`,loader:`${this.prefix}-loader`},this.submitVote=this.submitVote.bind(this),this.preparePolls()}preparePolls(){const t=[];this.polls.forEach(e=>{t.push(this.requestPoll(e.getAttribute("data-poll")).then(t=>this.renderTemplate(t,e)).catch(t=>console.log(t)))}),Promise.all(t).then(()=>this.eventHandlers())}requestPoll(t){const e=t?`${onyxpoll.apiurl}onyx/polls/list/?id=${t}`:`${onyxpoll.apiurl}onyx/polls/list/?modal=1`;return new Promise((t,s)=>{const o=new XMLHttpRequest;o.open("GET",e),o.send(null),o.onload=function(){if(this.status>=200&&this.status<400){const e=JSON.parse(this.response);self.response[e.id]=e,t(e)}else s("Poll cannot be loaded.")}})}requestVote(t){const e={choice:t.getAttribute("data-choice"),poll:t.getAttribute("data-poll")};return new Promise((t,s)=>{const o=new XMLHttpRequest;o.open("POST",`${onyxpoll.apiurl}onyx/polls/vote`),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(e)),o.onload=function(){if(this.status>=200&&this.status<400){const e=JSON.parse(this.response);self.response[e.poll]=e,t(e)}else s("Voting not completed.")}})}renderTemplate(t,e){e.innerHTML=`\n\t\t\t<div id='${this.name.wrapper}-${t.id}' class="${this.name.wrapper}">\n\t\t\t\t<p class='${this.name.question}'>${t.title}</p>\n\t\t\t\t<ul class='${this.name.list}'></ul>\n\t\t\t\t<div class="${this.name.footer}">\n\t\t\t\t\t<p class='${this.name.message}'></p>\n\t\t\t\t\t${t.results?`\n\t\t\t\t\t\t<p class='${this.name.total}'>\n\t\t\t\t\t\t\t<strong>${onyxpoll.labels.total}: </strong>\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t</p>\n\t\t\t\t\t`:""}\n\t\t\t\t\t${void 0!==t.results?`\n\t\t\t\t\t\t<a href="#" class="onyx-poll-ft-btn ${this.name.voteButton}">${onyxpoll.labels.vote}</a>\n\t\t\t\t\t\t<a href="#" class="onyx-poll-ft-btn ${this.name.viewButton}">${onyxpoll.labels.view}</a>\n\t\t\t\t\t`:""}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<span class="${this.name.loader}"><span class="spinner"></span></span>\n\t\t\t${e.id===this.name.modal?`\n\t\t\t\t<span class="${this.name.closeButton}"></span>\n\t\t\t`:""}\n\t\t`,e.list=e.querySelector(`.${this.name.list}`),t.answers.forEach(s=>{const o=document.createElement("li");o.setAttribute("data-choice",s.option),o.setAttribute("data-poll",t.id),o.className=this.name.choice,o.innerHTML=`<span>${s.answer}</span>`,e.list.appendChild(o)})}eventHandlers(){this.element.choices=document.querySelectorAll(`.${this.name.choice}`),this.element.message=document.querySelector(`.${this.name.message}`),this.element.voteButton=document.querySelectorAll(`.${this.name.voteButton}`),this.element.viewButton=document.querySelectorAll(`.${this.name.viewButton}`),this.element.closeButton=document.querySelector(`.${this.name.closeButton}`),"undefined"!=typeof onyxPollModal&&(this.element.modal=document.getElementById(this.name.modal),this.element.modal.classList.add("show"),this.element.closeButton.onclick=()=>this.element.modal.remove());for(let t=0;t<this.element.viewButton.length;t++)this.element.viewButton[t].onclick=()=>this.showResults(),this.element.voteButton[t].onclick=()=>this.showPoll();for(let t=0;t<this.element.choices.length;t++)this.element.choices[t].addEventListener("click",this.submitVote)}submitVote(t){t.preventDefault();const e=t.target,s=e.closest(`.${this.name.parent}`);this.togglePollLoader(s,!1),this.requestVote(e).then(function(t){this.togglePollLoader(s,!0),this.handleMessage(t.message,t.code),s.classList.add("voted"),"success"==t.code&&e.classList.add("choosed"),void 0!==t.results?s.querySelector(`.${this.name.viewButton}`).click():s.querySelector(`.${this.name.list}`).remove()}.bind(this)).catch(function(t){console.warn(t),this.togglePollLoader(s,!0),this.handleMessage(onyxpoll.labels.error,"error")}.bind(this))}showResults(){event.preventDefault();const t=event.target.closest(`.${this.name.parent}`),e=this.response[t.getAttribute("data-poll")];t.classList.add("view"),t.querySelector(`.${this.name.total} span`).textContent=e.results.total;const s=this.getCookie(`onyx_poll_cookie_${e.id}`);s&&t.querySelector(`li[data-choice="${s}"]`).classList.add("choosed"),t.querySelectorAll(`.${this.name.choice}`).forEach((t,s)=>{const o=e.answers[s].votes,n=e.answers[s].percent.toFixed(2)+"%";let l=`${o} ${onyxpoll.labels.votes} / ${n}`;2==e.type?l=`${o} ${onyxpoll.labels.votes}`:1==e.type&&(l=`${n}`),t.removeEventListener("click",this.submitVote),t.style.setProperty("--choicePercentage",`${n}`),t.style.setProperty("--choiceResult",`"${l}"`)})}showPoll(){event.preventDefault();const t=event.target.closest(`.${this.name.parent}`);t.classList.remove("view"),t.querySelectorAll(`.${this.name.choice}`).forEach((t,e)=>{t.addEventListener("click",this.submitVote),t.classList.remove("choosed"),t.style.removeProperty("--choicePercentage"),t.style.removeProperty("--choiceResult")})}handleMessage(t,e){const s=this.element.message;s.classList.remove("error","success","warn","not_allowed"),s.classList.add(e),s.textContent=t}togglePollLoader(t,e=!0){let s,o;e?(s="loading",o="active"):(s="active",o="loading"),t.classList.remove(s),t.classList.add(o)}getCookie(t){for(var e=t+"=",s=decodeURIComponent(document.cookie).split(";"),o=0;o<s.length;o++){for(var n=s[o];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(e))return n.substring(e.length,n.length)}return""}}}();